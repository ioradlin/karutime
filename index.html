<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì¹´ë£¨íƒ€ ë…ìŠµ íƒ€ì´ë¨¸ (ëª¨ë°”ì¼)</title>
  <style>
    :root {
      --bg:#ffffff; --card:#e5eee4; --ink:#111; --muted:#314642; --line:#434e48; --accent:#8692a8;
      --radius:16px;
      --p-lower:#faf9ec;
      --p-resonance:#ffffff;
      --p-maai:#ffffff;
      --p-upper:#c1dbcb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, 'Noto Sans KR', sans-serif}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{font-weight:700;font-size:18px}
    .btn{background:var(--card);border:1px solid var(--line);padding:10px 14px;border-radius:14px;cursor:pointer}
    .btn:active{transform:scale(.98)}
    .btns{display:flex;gap:8px;align-items:center}
    .btn.active{outline:2px solid var(--accent)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    .textbox{background:#fefff9;border:0.5px solid var(--line);border-radius:12px;padding:12px;min-height:56px;white-space:pre-wrap;word-break:break-word}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row-ctr{display:flex;gap:8px;align-items:center;justify-content:center}
    .progress{height:12px;background:#e9e9f2;border-radius:999px;overflow:visible;position:relative}
    .bar{height:100%;width:0;background:var(--accent);border-radius:999px;position:relative;z-index:2}
    .track{position:absolute;inset:0;border-radius:999px;z-index:1;overflow:hidden}
    .seg{position:absolute;top:0;bottom:0}
    .tick{position:absolute;top:-6px;bottom:-6px;width:2px;background:#b8b8c7;z-index:3}
    .small{font-size:12px;color:var(--muted)}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:12px;font-weight:600}
    .phase-idle{background:#f2f3ec}
    .phase-lower{background:var(--p-lower)}
    .phase-resonance{background:var(--p-resonance)}
    .phase-maai{background:var(--p-maai)}
    .phase-upper{background:var(--p-upper)}
    .phase-done{background:#e9ecef}
    .nextbox{background:#c1dbcb;border:1px dashed #5a5e5b}
    .error{color:#b00020}
    .footer {
  max-width: 720px;
  margin: 12px auto 24px;
  color: #999;
  font-size: 12px;
  display: flex;
  justify-content: flex-end;
  padding-right: 16px;  /* â† ì—¬ê¸° */
}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">ğŸƒ ì¹´ë£¨íƒ€ ë…ìˆ˜ íƒ€ì´ë¨¸</div>
      <div class="btns">
        <button id="shuffle" class="btn">ì…”í”Œ</button>
        <button id="show-hira" class="btn" aria-pressed="false">ë°œìŒ</button>
        <button id="show-kr" class="btn" aria-pressed="false">í•´ì„</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;margin-bottom:10px">
        <div class="small">ìˆœë²ˆ: <span id="idx">1</span> / <span id="total">0</span></div>
        <div id="phaseBadge" class="badge phase-idle">í˜ì´ì¦ˆ: <span id="phaseLabel">ëŒ€ê¸°</span></div>
      </div>

      <div class="progress" aria-label="progress">
        <div class="track" id="track"></div>
        <div id="bar" class="bar"></div>
      </div>

      <!-- ì§€ê¸ˆ ìƒêµ¬ â†’ ì§€ê¸ˆ í•˜êµ¬ â†’ ë‹¤ìŒ ìƒêµ¬ -->
      <div style="margin-top:14px" class="card">
        <div class="label">ì§€ê¸ˆ ìƒêµ¬ï¼ˆä¸Šã®å¥ï¼‰</div>
        <div id="kami" class="textbox">â€”</div>
        <div class="label" style="margin-top:12px">ì§€ê¸ˆ í•˜êµ¬ï¼ˆä¸‹ã®å¥ï¼‰</div>
        <div id="shimo" class="textbox">â€”</div>
        <div class="label" style="margin-top:12px">ë‹¤ìŒ ìƒêµ¬ï¼ˆNext ä¸Šã®å¥ï¼‰</div>
        <div id="next-kami" class="textbox nextbox">â€”</div>

        <!-- íƒ­ í‘œì‹œ ì˜ì—­ -->
        <div id="hira-wrap" class="hidden" style="margin-top:12px">
          <div class="label">ë°œìŒï¼ˆã²ã‚‰ãŒãªï¼‰</div>
          <div id="poem-hira" class="textbox">â€”</div>
        </div>
        <div id="kr-wrap" class="hidden" style="margin-top:12px">
          <div class="label">í•´ì„ï¼ˆí•œêµ­ì–´ï¼‰</div>
          <div id="poem-kr" class="textbox">â€”</div>
        </div>
      </div>

      <div class="row-ctr" style="margin-top:12px">
        <button id="prev" class="btn">âŸµ ì´ì „ (P)</button>
        <button id="toggle" class="btn">ì‹œì‘ (Space)</button>
        <button id="next" class="btn">ë‹¤ìŒ (N) âŸ¶</button>
      </div>

      <audio id="audio-upper" preload="none"></audio>
      <audio id="audio-lower" preload="none"></audio>
    </div>
  </div>
  <footer class="footer">Made by Hyelin</footer>

  <script>
    // íƒ€ì´ë° (5Â·3Â·1Â·6)
    const TIMING = { lower:5.0, resonance:3.0, maai:1.0, upper:6.0 };
    const TOTAL = TIMING.lower + TIMING.resonance + TIMING.maai + TIMING.upper;

    // ì´ˆê¸° ì¹´ë“œ(í´ë°±)
    const seeded = [
      { id:0, text:"", kami:"", shimo:"", poem_hira:"", poem_kr:"" },
      { id:1, kami:"ç§‹(ã‚ã)ã®ç”°(ãŸ)ã®ãƒ¼ã‹ã‚Šã»ã®åºµ(ã„ã»)ã®ãƒ¼è‹«(ã¨ã¾)ã‚’è’(ã‚ã‚‰)ãƒ¼ã¿ãƒ¼", shimo:"ã‚ãŒãƒ¼è¡£æ‰‹(ã“ã‚ã‚‚ã§)ã¯ãƒ¼éœ²(ã¤ã‚†)ã«ã¬ã‚Œãƒ¼ã¤ã¤â¸º", poem_hira:"", poem_kr:"" },
      { id:2, kami:"æ˜¥é(ã¯ã‚‹ã™ã)ã¦ãƒ¼å¤æ¥(ãªã¤ã)ã«ã‘(ã‚‰ã—)ãƒ¼ç™½å¦™(ã—ã‚ãŸãˆ)ãƒ¼ã®ãƒ¼", shimo:"è¡£(ã“ã‚ã‚‚)ãƒ¼ã»(ã™ã¦ãµ)ãƒ¼å¤©(ã‚ã¾)ã®é¦™å…·å±±(ã‹ãã‚„ã¾)â¸º", poem_hira:"", poem_kr:"" }
    ];

    let cards = seeded.slice();
    let order = cards.map(c=>c.id);
    let idx = 0;
    let phase = 'idle';
    let playing = false;
    let remaining = 0;
    let raf = null;

    // Tabs ìƒíƒœ (ë³´ì„ ìœ ì§€ + ì¹´ë“œ ì´ë™ ì‹œ ë‚´ìš© ë™ê¸°í™”)
    let showHira = false;
    let showKr = false;

    // refs
    const elKami = document.getElementById('kami');
    const elShimo = document.getElementById('shimo');
    const elNextKami = document.getElementById('next-kami');
    const elIdx = document.getElementById('idx');
    const elTotal = document.getElementById('total');
    const elPhase = document.getElementById('phaseLabel');
    const elPhaseBadge = document.getElementById('phaseBadge');
    const elBar = document.getElementById('bar');
    const elTrack = document.getElementById('track');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');
    const btnToggle = document.getElementById('toggle');
    const btnShuffle = document.getElementById('shuffle');
    const btnShowHira = document.getElementById('show-hira');
    const btnShowKr = document.getElementById('show-kr');
    const hiraWrap = document.getElementById('hira-wrap');
    const krWrap = document.getElementById('kr-wrap');
    const elPoemHira = document.getElementById('poem-hira');
    const elPoemKr = document.getElementById('poem-kr');
    const audioUpper = document.getElementById('audio-upper');
    const audioLower = document.getElementById('audio-lower');

    function shuffle(a){ const arr=a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

    // ì •ìˆœ(0 ê³ ì •, ë‚˜ë¨¸ì§€ ì˜¤ë¦„ì°¨ìˆœ)
    function buildOrderSortedKeepZeroFirst(){
      const ids = cards.map(c=>c.id).filter(id=>typeof id==='number' && !Number.isNaN(id));
      const rest = ids.filter(id=>id!==0).sort((a,b)=>a-b);
      return ids.includes(0) ? [0, ...rest] : rest;
    }

    // ì…”í”Œ(0 ê³ ì •, ë‚˜ë¨¸ì§€ ëœë¤)
    function buildOrderShuffledKeepZeroFirst(){
      const ids=cards.map(c=>c.id);
      if(ids.includes(0)){ const rest=ids.filter(id=>id!==0); return [0, ...shuffle(rest)]; }
      return shuffle(ids);
    }

    function getCss(v){return getComputedStyle(document.documentElement).getPropertyValue(v).trim();}

    function drawSegments(){
      elTrack.innerHTML='';
      const segs=[
        {width:TIMING.lower/TOTAL,color:getCss('--p-lower')},
        {width:TIMING.resonance/TOTAL,color:getCss('--p-resonance')},
        {width:TIMING.maai/TOTAL,color:getCss('--p-maai')},
        {width:TIMING.upper/TOTAL,color:getCss('--p-upper')}
      ];
      let left=0;
      segs.forEach((s,i)=>{
        const seg=document.createElement('div');
        seg.className='seg'; seg.style.left=(left*100)+'%'; seg.style.width=(s.width*100)+'%'; seg.style.background=s.color;
        elTrack.appendChild(seg);
        left+=s.width;
        if(i<segs.length-1){
          const tick=document.createElement('div');
          tick.className='tick';
          tick.style.left=(left*100)+'%';
          elTrack.appendChild(tick);
        }
      });
    }

    function updatePhaseUI(){
      const map={
        idle:{label:'ëŒ€ê¸°',cls:'phase-idle'},
        lower:{label:'í•˜êµ¬',cls:'phase-lower'},
        resonance:{label:'ì—¬ìš´',cls:'phase-resonance'},
        maai:{label:'ê°„ê²©',cls:'phase-maai'},
        upper:{label:'ìƒêµ¬',cls:'phase-upper'},
        done:{label:'ì™„ë£Œ',cls:'phase-done'}
      };
      const info=map[phase]||map.idle;
      elPhase.textContent=info.label; elPhaseBadge.className='badge '+info.cls;
    }

    function getPhaseTime(p){return TIMING[p]||0;}

    function updateBar(){
      let before=0;
      if(phase==='resonance') before=TIMING.lower;
      if(phase==='maai') before=TIMING.lower+TIMING.resonance;
      if(phase==='upper') before=TIMING.lower+TIMING.resonance+TIMING.maai;
      const elapsed=Math.max(0,before+((phase==='idle'||phase==='done')?0:(getPhaseTime(phase)-remaining)));
      elBar.style.width=Math.min(100,(elapsed/TOTAL)*100)+'%';
    }

    function currentCard(){
      const id=order[idx];
      return cards.find(x=>x.id===id)||{};
    }

    function syncOptionalPanels(cur){
      // ë°œìŒ/í•´ì„ íƒ­ì´ "ì¼œì ¸" ìˆëŠ” ê²½ìš°ì—ë§Œ ë‚´ìš© ê°±ì‹ 
      if(showHira){ elPoemHira.textContent = (cur.poem_hira||'â€”'); }
      if(showKr){   elPoemKr.textContent   = (cur.poem_kr  ||'â€”'); }
    }

    function setCard(i){
      idx=Math.max(0,Math.min(order.length-1,i));
      const cur=currentCard();
      elKami.textContent=cur.kami||'â€”';
      elShimo.textContent=(Object.prototype.hasOwnProperty.call(cur,'simo')?cur.simo:cur.shimo)||'â€”';
      elIdx.textContent=String(idx+1);
      elTotal.textContent=String(order.length);
      const next=cards.find(x=>x.id===order[idx+1]);
      elNextKami.textContent=next?.kami||'â€”';
      audioUpper.src=cur.audio_upper||'';
      audioLower.src=cur.audio_lower||'';
      syncOptionalPanels(cur);  // â† ì¹´ë“œ ì´ë™ ì‹œ ë°œìŒ/í•´ì„ë„ ê°™ì´ ì´ë™
      resetTimer();
    }

    function resetTimer(){stop(); phase='idle'; remaining=0; updatePhaseUI(); updateBar();}

    function start(){
      if(playing) return;
      if(phase==='idle'||phase==='done'){
        phase='lower'; remaining=TIMING.lower;
        try{ if(audioLower.src) audioLower.play(); }catch(e){}
      }
      playing=true; btnToggle.textContent='ì¼ì‹œì •ì§€ (Space)'; updatePhaseUI();
      let last=performance.now();
      const step=(now)=>{
        const dt=(now-last)/1000; last=now;
        remaining=Math.max(0,remaining-dt);
        if(remaining===0) advancePhase();
        updateBar();
        if(playing) raf=requestAnimationFrame(step);
      };
      raf=requestAnimationFrame(step);
    }

    function stop(){playing=false; if(raf) cancelAnimationFrame(raf); raf=null; btnToggle.textContent='ì‹œì‘ (Space)'; updateBar();}

    function toggle(){playing?stop():start();}

    function advancePhase(){
      if(phase==='lower'){phase='resonance'; remaining=TIMING.resonance;}
      else if(phase==='resonance'){phase='maai'; remaining=TIMING.maai;}
      else if(phase==='maai'){phase='upper'; remaining=TIMING.upper; try{ if(audioUpper.src) audioUpper.play(); }catch(e){}}
      else if(phase==='upper'){phase='done'; remaining=0; stop();}
      updatePhaseUI();
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    btnPrev.onclick=()=>setCard(idx-1);
    btnNext.onclick=()=>setCard(idx+1);

    btnShuffle.onclick=()=>{ order=buildOrderShuffledKeepZeroFirst(); setCard(0); };
    btnToggle.onclick=toggle;

    // íƒ­(ë°œìŒ/ì›ë¬¸) í† ê¸€: í‘œì‹œ/ìˆ¨ê¹€ + ìƒíƒœ ë°˜ì˜
    function toggleTab(kind){
      const isHira = (kind==='hira');
      if(isHira){
        showHira = !showHira;
        btnShowHira.classList.toggle('active', showHira);
        btnShowHira.setAttribute('aria-pressed', String(showHira));
        hiraWrap.classList.toggle('hidden', !showHira);
        if(showHira) elPoemHira.textContent = currentCard().poem_hira || 'â€”';
      }else{
        showKr = !showKr;
        btnShowKr.classList.toggle('active', showKr);
        btnShowKr.setAttribute('aria-pressed', String(showKr));
        krWrap.classList.toggle('hidden', !showKr);
        if(showKr) elPoemKr.textContent = currentCard().poem_kr || 'â€”';
      }
    }
    btnShowHira.onclick=()=>toggleTab('hira');
    btnShowKr.onclick=()=>toggleTab('kr');

    // ë‹¨ì¶•í‚¤
    window.addEventListener('keydown',e=>{
      const k=e.key.toLowerCase();
      if(k===' '){e.preventDefault(); toggle();}
      if(k==='n') setCard(idx+1);
      if(k==='p') setCard(idx-1);
      if(k==='r'){ order=buildOrderShuffledKeepZeroFirst(); setCard(0); }
      if(k==='h'){ toggleTab('hira'); }
      if(k==='k'){ toggleTab('kr'); }
    });

    async function loadCards(){
      try{
        const res=await fetch('./cards.json',{cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const json=await res.json();
        if(!Array.isArray(json)) throw new Error('cards.jsonì€ ë°°ì—´ì´ì–´ì•¼ í•©ë‹ˆë‹¤');

        cards=json.map((x,i)=>({
          id:Number(x.id??i),
          text:x.text||'',
          kami:x.kami||'',
          shimo:(Object.prototype.hasOwnProperty.call(x,'simo')?x.simo:(x.shimo||'')),
          poem_hira:x.poem_hira||'',
          poem_kr:x.poem_kr||'',
          audio_upper:x.audio_upper||'',
          audio_lower:x.audio_lower||''
        }));

        // ì´ˆê¸° ë¡œë“œëŠ” ì •ìˆœ(0 â†’ 1 â†’ â€¦)
        order = buildOrderSortedKeepZeroFirst();
        setCard(0);
      }catch(err){
        // í´ë°±: ì‹œë“œ + ì •ìˆœ
        cards=seeded.slice();
        order = buildOrderSortedKeepZeroFirst();
        setCard(0);
      }
    }

    // ì´ˆê¸° ë Œë”
    (function init(){
      drawSegments();
      loadCards();
    })();
  </script>
</body>
</html>
